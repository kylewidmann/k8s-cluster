---
# Setup alternative K3s directory if specified
- name: Setup alternative K3s directory
  when:
    - k3s_server_location is defined
    - k3s_server_location != "/var/lib/rancher/k3s"
  block:
    - name: Make rancher directory
      ansible.builtin.file:
        path: /var/lib/rancher
        mode: "0755"
        state: directory

    - name: Create symlink
      ansible.builtin.file:
        dest: /var/lib/rancher/k3s
        src: "{{ k3s_server_location }}"
        force: true
        state: link

# Setup extra manifests if defined
- name: Setup extra manifests
  when: extra_manifests is defined
  block:
    - name: Make manifests directory
      ansible.builtin.file:
        path: /var/lib/rancher/k3s/server/manifests
        mode: "0700"
        state: directory

    - name: Copy manifests
      ansible.builtin.copy:
        src: "{{ item }}"
        dest: /var/lib/rancher/k3s/server/manifests
        mode: "0600"
      loop: "{{ extra_manifests }}"

# Setup optional private registry configuration
- name: Setup private registry configuration
  when: registries_config_yaml is defined
  block:
    - name: Make k3s config directory
      ansible.builtin.file:
        path: /etc/rancher/k3s
        mode: "0755"
        state: directory

    - name: Set registry hostname
      ansible.builtin.set_fact:
        registry_hostname: "{{ validator | lower }}.localregistry.chutes.ai"

    - name: Create registries.yaml for K3s
      ansible.builtin.template:
        src: registries.yaml.j2
        dest: /etc/rancher/k3s/registries.yaml
        mode: "0644"
      notify: restart k3s
